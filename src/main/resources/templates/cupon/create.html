<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(
          pageTitle='Crear Cupón',
          breadcrumb='Cupones / Crear Nuevo',
          contentFragment=~{::content}
      )}">
<body>
<div th:fragment="content">
    <!-- Mensajes -->
    <div th:replace="~{messages :: messages}"></div>

    <!-- Botón volver -->
    <div style="margin-bottom: 20px;">
        <a th:href="@{/web/cupones}" class="btn btn-secondary">
            <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 5px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Volver al Listado
        </a>
    </div>

    <h3 class="card-title">Crear Nuevo Cupón de Descuento</h3>

    <!-- Formulario -->
    <form th:action="@{/web/cupones/create}" method="post" id="formCrearCupon" onsubmit="return validarFormulario()">
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Código -->
            <div class="form-group">
                <label for="codigo">
                    Código del Cupón <span style="color: #ef4444;">*</span>
                </label>
                <input type="text" 
                       id="codigo"
                       name="codigo" 
                       th:value="${codigo}" 
                       required
                       minlength="3"
                       maxlength="100"
                       placeholder="Ej: BLACKFRIDAY25"
                       style="text-transform: uppercase; font-family: monospace;">
                <small style="color: #6b7280; font-size: 12px;">Mínimo 3 caracteres. Se guardará en MAYÚSCULAS</small>
            </div>

            <!-- Estado Activo -->
            <div class="form-group">
                <label for="activo">Estado</label>
                <div style="display: flex; align-items: center; padding: 10px 0;">
                    <input type="checkbox" 
                           id="activo"
                           name="activo" 
                           th:checked="${activo}"
                           style="width: auto; margin-right: 10px;">
                    <label for="activo" style="margin: 0; font-weight: normal;">Cupón activo</label>
                </div>
                <small style="color: #6b7280; font-size: 12px;">Solo los cupones activos pueden ser usados</small>
            </div>

            <!-- Tipo de Descuento -->
            <div class="form-group">
                <label for="tipo">
                    Tipo de Descuento <span style="color: #ef4444;">*</span>
                </label>
                <select id="tipo" name="tipo" required onchange="actualizarCampoValor()">
                    <option value="PORCENTAJE" th:selected="${tipo == 'PORCENTAJE' or tipo == null}">Porcentaje (%)</option>
                    <option value="MONTO_FIJO" th:selected="${tipo == 'MONTO_FIJO'}">Monto Fijo ($)</option>
                </select>
            </div>

            <!-- Valor del Descuento -->
            <div class="form-group">
                <label for="valorDescuento">
                    Valor del Descuento <span style="color: #ef4444;">*</span>
                </label>
                <input type="number" 
                       id="valorDescuento"
                       name="valorDescuento" 
                       th:value="${valorDescuento}" 
                       required
                       min="0.01"
                       step="0.01"
                       placeholder="0.00">
                <small id="valorDescuentoHelp" style="color: #6b7280; font-size: 12px;">Para porcentaje: valor entre 0 y 100</small>
            </div>

            <!-- Mínimo de Compra -->
            <div class="form-group">
                <label for="minimoCompra">
                    Mínimo de Compra <span style="color: #6b7280;">(opcional)</span>
                </label>
                <input type="number" 
                       id="minimoCompra"
                       name="minimoCompra" 
                       th:value="${minimoCompra}" 
                       min="0.01"
                       step="0.01"
                       placeholder="0.00">
                <small style="color: #6b7280; font-size: 12px;">Monto mínimo requerido para usar el cupón</small>
            </div>

            <!-- Tope de Descuento -->
            <div class="form-group">
                <label for="topeDescuento">
                    Tope de Descuento <span style="color: #6b7280;">(opcional)</span>
                </label>
                <input type="number" 
                       id="topeDescuento"
                       name="topeDescuento" 
                       th:value="${topeDescuento}" 
                       min="0.01"
                       step="0.01"
                       placeholder="0.00">
                <small style="color: #6b7280; font-size: 12px;">Límite máximo de descuento</small>
            </div>

            <!-- Fecha de Inicio -->
            <div class="form-group">
                <label for="fechaInicio">
                    Fecha de Inicio <span style="color: #6b7280;">(opcional)</span>
                </label>
                <input type="date" 
                       id="fechaInicio"
                       name="fechaInicio" 
                       th:value="${fechaInicio}">
                <small style="color: #6b7280; font-size: 12px;">Desde cuándo es válido el cupón</small>
            </div>

            <!-- Fecha de Fin -->
            <div class="form-group">
                <label for="fechaFin">
                    Fecha de Fin <span style="color: #6b7280;">(opcional)</span>
                </label>
                <input type="date" 
                       id="fechaFin"
                       name="fechaFin" 
                       th:value="${fechaFin}">
                <small style="color: #6b7280; font-size: 12px;">Hasta cuándo es válido el cupón</small>
            </div>
        </div>

        <!-- Botones -->
        <div style="margin-top: 30px; display: flex; gap: 10px;">
            <button type="submit" class="btn btn-success">
                <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 5px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Crear Cupón
            </button>
            <a th:href="@{/web/cupones}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>

    <!-- Script de validación -->
    <script>
        function actualizarCampoValor() {
            const tipo = document.getElementById('tipo').value;
            const helpText = document.getElementById('valorDescuentoHelp');
            
            if (tipo === 'PORCENTAJE') {
                helpText.textContent = 'Para porcentaje: valor entre 0 y 100';
            } else {
                helpText.textContent = 'Para monto fijo: valor en dólares';
            }
        }

        function validarFormulario() {
            const errorMessages = document.querySelectorAll('.error-message');
            errorMessages.forEach(msg => msg.remove());

            let esValido = true;

            // Validar Código
            const codigo = document.getElementById('codigo');
            if (!codigo.value || codigo.value.trim().length < 3) {
                mostrarError(codigo, 'El código debe tener al menos 3 caracteres');
                esValido = false;
            }

            // Validar Tipo
            const tipo = document.getElementById('tipo');
            if (!tipo.value) {
                mostrarError(tipo, 'Debe seleccionar un tipo de descuento');
                esValido = false;
            }

            // Validar Valor
            const valor = document.getElementById('valorDescuento');
            if (!valor.value || parseFloat(valor.value) <= 0) {
                mostrarError(valor, 'El valor debe ser mayor a 0');
                esValido = false;
            }

            // Validar porcentaje no mayor a 100
            if (tipo.value === 'PORCENTAJE' && parseFloat(valor.value) > 100) {
                mostrarError(valor, 'El porcentaje no puede ser mayor a 100');
                esValido = false;
            }

            // Validar fechas
            const fechaInicio = document.getElementById('fechaInicio');
            const fechaFin = document.getElementById('fechaFin');
            
            if (fechaInicio.value && fechaFin.value) {
                if (new Date(fechaInicio.value) > new Date(fechaFin.value)) {
                    mostrarError(fechaFin, 'La fecha de fin debe ser posterior a la de inicio');
                    esValido = false;
                }
            }

            if (!esValido) {
                const primerError = document.querySelector('.error-message');
                if (primerError) {
                    primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            return esValido;
        }

        function mostrarError(input, mensaje) {
            input.style.borderColor = '#ef4444';
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.style.color = '#ef4444';
            errorDiv.style.fontSize = '12px';
            errorDiv.style.marginTop = '5px';
            errorDiv.textContent = mensaje;
            
            input.parentNode.appendChild(errorDiv);
        }

        // Limpiar errores al escribir
        document.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('input', function() {
                this.style.borderColor = '';
                const errorMsg = this.parentNode.querySelector('.error-message');
                if (errorMsg) {
                    errorMsg.remove();
                }
            });
        });

        // Inicializar el texto de ayuda
        actualizarCampoValor();
    </script>

    <!-- Script para auto-ocultar mensajes -->
    <script th:replace="~{messages :: auto-hide-messages}"></script>
</div>
</body>
</html>