<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(
          pageTitle='Crear Usuario',
          breadcrumb='Usuarios / Crear Nuevo',
          contentFragment=~{::content}
      )}">
<body>
<div th:fragment="content">
    <!-- Mensajes -->
    <div th:replace="~{messages :: messages}"></div>

    <!-- Botón volver -->
    <div style="margin-bottom: 20px;">
        <a th:href="@{/web/usuarios}" class="btn btn-secondary">
            <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 5px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Volver al Listado
        </a>
    </div>

    <h3 class="card-title">Crear Nuevo Usuario</h3>

    <!-- Formulario -->
    <form th:action="@{/web/usuarios/create}" method="post" id="formCrearUsuario" onsubmit="return validarFormulario()">
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Nombre -->
            <div class="form-group">
                <label for="nombre">
                    Nombre Completo <span style="color: #ef4444;">*</span>
                </label>
                <input type="text" 
                       id="nombre"
                       name="nombre" 
                       th:value="${nombre}" 
                       required
                       minlength="3"
                       maxlength="150"
                       placeholder="Ej: Juan Pérez">
                <small style="color: #6b7280; font-size: 12px;">Mínimo 3 caracteres</small>
            </div>

            <!-- Correo -->
            <div class="form-group">
                <label for="correo">
                    Correo Electrónico <span style="color: #ef4444;">*</span>
                </label>
                <input type="email" 
                       id="correo"
                       name="correo" 
                       th:value="${correo}" 
                       required
                       maxlength="150"
                       placeholder="usuario@ejemplo.com">
                <small style="color: #6b7280; font-size: 12px;">Debe ser un correo válido</small>
            </div>

            <!-- Contraseña -->
            <div class="form-group">
                <label for="contrasena">
                    Contraseña <span style="color: #ef4444;">*</span>
                </label>
                <input type="password" 
                       id="contrasena"
                       name="contrasena" 
                       required
                       minlength="6"
                       maxlength="255"
                       placeholder="••••••••">
                <small style="color: #6b7280; font-size: 12px;">Mínimo 6 caracteres</small>
            </div>

            <!-- Rol -->
            <div class="form-group">
                <label for="rol">
                    Rol <span style="color: #ef4444;">*</span>
                </label>
                <select id="rol" name="rol" required>
                    <option value="CUSTOMER" th:selected="${rol == 'CUSTOMER' or rol == null}">Cliente (CUSTOMER)</option>
                    <option value="ADMIN" th:selected="${rol == 'ADMIN'}">Administrador (ADMIN)</option>
                </select>
                <small style="color: #6b7280; font-size: 12px;">Seleccione el tipo de usuario</small>
            </div>
        </div>

        <!-- Botones -->
        <div style="margin-top: 30px; display: flex; gap: 10px;">
            <button type="submit" class="btn btn-success">
                <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 5px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Crear Usuario
            </button>
            <a th:href="@{/web/usuarios}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>

    <!-- Script de validación -->
    <script>
        function validarFormulario() {
            const errorMessages = document.querySelectorAll('.error-message');
            errorMessages.forEach(msg => msg.remove());

            let esValido = true;

            // Validar Nombre
            const nombre = document.getElementById('nombre');
            if (!nombre.value || nombre.value.trim().length < 3) {
                mostrarError(nombre, 'El nombre debe tener al menos 3 caracteres');
                esValido = false;
            }

            // Validar Correo
            const correo = document.getElementById('correo');
            const emailRegex = /^[A-Za-z0-9+_.-]+@(.+)$/;
            if (!correo.value || !emailRegex.test(correo.value)) {
                mostrarError(correo, 'Debe ingresar un correo válido');
                esValido = false;
            }

            // Validar Contraseña
            const contrasena = document.getElementById('contrasena');
            if (!contrasena.value || contrasena.value.length < 6) {
                mostrarError(contrasena, 'La contraseña debe tener al menos 6 caracteres');
                esValido = false;
            }

            // Validar Rol
            const rol = document.getElementById('rol');
            if (!rol.value) {
                mostrarError(rol, 'Debe seleccionar un rol');
                esValido = false;
            }

            if (!esValido) {
                const primerError = document.querySelector('.error-message');
                if (primerError) {
                    primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            return esValido;
        }

        function mostrarError(input, mensaje) {
            input.style.borderColor = '#ef4444';
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.style.color = '#ef4444';
            errorDiv.style.fontSize = '12px';
            errorDiv.style.marginTop = '5px';
            errorDiv.textContent = mensaje;
            
            input.parentNode.appendChild(errorDiv);
        }

        // Limpiar errores al escribir
        document.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('input', function() {
                this.style.borderColor = '';
                const errorMsg = this.parentNode.querySelector('.error-message');
                if (errorMsg) {
                    errorMsg.remove();
                }
            });
        });
    </script>

    <!-- Script para auto-ocultar mensajes -->
    <script th:replace="~{messages :: auto-hide-messages}"></script>
</div>
</body>
</html>